import os 

configfile: "configs/config.json"

# Get all combinations through the config file
def get_combinations(config):
    # Iterate over keys and values of config
    combinations = []
    for key, value in config.items():
        data_folder = value["data_folder"]
        ds_celltypes = value["ds_celltypes"]
        ds_proportions = value["ds_proportions"]
        num_batches = value["num_batches"]
        repetitions = value["repetitions"]
        # Get combinations of celltypes and proportions
        for num_batch in num_batches:
            if num_batch == 0:
                combinations.append(
                    "{data_folder}_{ds_celltype}_celltypes_{ds_proportion}_downsample_{num_batch}_batch_ds_c_1".format(
                        data_folder = data_folder,
                        ds_celltype = 0, 
                        ds_proportion = 1,
                        num_batch = num_batch
                    )
                )   
                continue
            for ds_celltype in ds_celltypes:
                for ds_proportion in ds_proportions:
                    for repetition in range(repetitions):
                        combinations.append(
                            "{data_folder}_{ds_celltype}_celltypes_{ds_proportion}_downsample_{num_batch}_batch_ds_c_{rep}".format(
                                data_folder = data_folder,
                                ds_celltype = ds_celltype, 
                                ds_proportion = ds_proportion,
                                num_batch = num_batch,
                                rep = repetition
                            )
                        )
    return combinations

# All rule
rule all:
    input:
        expand(
            "../results/{outputs[0]}/{dataset}_{outputs[1]}.tsv",
            dataset = get_combinations(config),
            outputs = zip(
                [
                    "downsample_summaries", 
                    "clustering_summaries", 
                    "clustering_concord_summaries",
                    "dge_concord_summaries"
                ], 
                [
                    "downsample_summary", 
                    "clustering_summary", 
                    "clustering_concord_summary",
                    "dge_concord_summary"
                ],
            )
        )

# Integrate the indicated h5ad files from config
rule integrate:
    conda:
        "envs/integrate.yaml"
    input:
        "../resources/h5ad_files/{data_folder}"
    output:
        temp("../results/integrated_results/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_integrated.h5ad")
    params:
        script_path = "scripts/python/integrate_data.py",
    log:
        "logs/integrate/integrate_{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}.log"
    shell:
        """
        python {params.script_path} \
            --filedir {input} \
            --ds_celltypes {wildcards.ds_celltype} \
            --ds_proportions {wildcards.ds_proportion} \
            --num_batches {wildcards.num_batches} \
            --outfile {output} \
            &> {log}
        """
        
# Get summary results of downsampling 
rule downsample_summary:
    conda:
        "envs/integrate.yaml"
    input:
        "../results/integrated_results/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_integrated.h5ad"
    output:
        "../results/downsample_summaries/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" + 
        "_downsample_{num_batches}_batch_ds_c_{rep}_downsample_summary.tsv"
    params:
        script_path = "scripts/python/downsample_summary.py",
    log:
        "logs/downsample_summary/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_downsample_summary.log"
    shell:
        """
        python {params.script_path} \
            --infile {input} \
            --outfile {output} \
            --dataset {wildcards.data_folder} \
            --rep {wildcards.rep} \
            &> {log}
        """
    
# Get cluster summary results of downsampling
rule clustering_summary:
    conda:
        "envs/integrate.yaml"
    input:
        "../results/integrated_results/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_integrated.h5ad"
    output:
        "../results/clustering_summaries/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" + 
        "_downsample_{num_batches}_batch_ds_c_{rep}_clustering_summary.tsv"
    params:
        script_path = "scripts/python/clustering_stats.py",
    log:
        "logs/clustering_summary/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_clustering_summary.log"
    shell:
        """
        python {params.script_path} \
            --infile {input} \
            --outfile {output} \
            --dataset {wildcards.data_folder} \
            --rep {wildcards.rep} \
            &> {log}
        """

# Get clustering concordance results (from different methods) from downsampling
rule clustering_concord_summary:
    conda:
        "envs/integrate.yaml"
    input:
        "../results/integrated_results/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_integrated.h5ad"
    output:
        "../results/clustering_concord_summaries/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" + 
        "_downsample_{num_batches}_batch_ds_c_{rep}_clustering_concord_summary.tsv"
    params:
        script_path = "scripts/python/clustering_concordance.py",
    log:
        "logs/clustering_concord_summary/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_clustering_concord_summary.log"
    shell:
        """
        python {params.script_path} \
            --infile {input} \
            --outfile {output} \
            --dataset {wildcards.data_folder} \
            --rep {wildcards.rep} \
            &> {log}
        """

# Get DGE concordance results (from different methods) from downsampling
rule dge_concord_summary:
    conda:
        "envs/integrate.yaml"
    input:
        "../results/integrated_results/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_integrated.h5ad"
    output:
        "../results/dge_concord_summaries/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" + 
        "_downsample_{num_batches}_batch_ds_c_{rep}_dge_concord_summary.tsv"
    params:
        script_path = "scripts/python/dge_concordance.py",
    log:
        "logs/dge_concord_summary/{data_folder}_{ds_celltype}_celltypes_{ds_proportion}" +
        "_downsample_{num_batches}_batch_ds_c_{rep}_dge_concord_summary.log"
    shell:
        """
        python {params.script_path} \
            --infile {input} \
            --outfile {output} \
            --dataset {wildcards.data_folder} \
            --rep {wildcards.rep} \
            &> {log}
        """